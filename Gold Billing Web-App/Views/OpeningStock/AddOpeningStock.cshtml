@using Gold_Billing_Web_App.Models.ViewModels
@model OpeningStockViewModel
@{
    ViewBag.Title = ViewBag.Title ?? "Add Opening Stock";
}

<!-- Existing styles remain unchanged -->

<div class="card" style="border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);">
    <div class="card-header" style="background: linear-gradient(135deg, #d4edda, #ffffff); border-top-left-radius: 15px; border-top-right-radius: 15px;">
        <h3 class="card-title text-center mb-0" style="font-family: 'Poppins', sans-serif; font-weight: 600; color: #2a5298; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);">@ViewBag.Title</h3>
    </div>
    <div class="card-body" style="background: linear-gradient(135deg, #d4edda, #ffffff); border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;">
        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert" style="border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); background: linear-gradient(to right, #f8d7da, #f1aeb5);">
                <h4 class="alert-heading" style="font-family: 'Poppins', sans-serif; font-weight: 500; color: #721c24;">Validation Errors</h4>
                <ul style="padding-left: 20px;">
                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                    {
                        <li style="color: #721c24;">@error.ErrorMessage</li>
                    }
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <form asp-action="AddOpeningStock" method="post" id="openingStockForm" style="font-family: 'Poppins', sans-serif;">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="UserId" />
            <input type="hidden" asp-for="BillNo" />
            <hr class="mb-4 mt-3" style="border: 1px solid #2a5298; opacity: 0.2;" />

            <div class="row mb-4">
                <div class="col-md-4">
                    <label asp-for="Date" class="form-label" style="font-weight: 500; color: #1e3c72;">Date</label>
                    <input asp-for="Date" type="date" class="form-control" style="border-radius: 10px; border: 1px solid #ced4da; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); padding: 10px; transition: all 0.3s ease;" />
                    <span asp-validation-for="Date" class="text-danger" style="font-size: 0.9em;"></span>
                </div>
                <div class="col-md-4 form-group">
                    <label asp-for="BillNo" class="form-label" style="font-weight: 500; color: #1e3c72;">Bill Number</label>
                    <input class="form-control" readonly value="@Model.BillNo" style="border-radius: 10px; background: #e9ecef; border: 1px solid #ced4da; padding: 10px; transition: all 0.3s ease;" />
                    <span asp-validation-for="BillNo" class="text-danger" style="font-size: 0.9em;"></span>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-md-6">
                    <label asp-for="Narration" class="form-label" style="font-weight: 500; color: #1e3c72;">Narration</label>
                    <textarea asp-for="Narration" class="form-control" style="border-radius: 10px; border: 1px solid #ced4da; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); padding: 10px; resize: vertical; transition: all 0.3s ease;"></textarea>
                    <span asp-validation-for="Narration" class="text-danger" style="font-size: 0.9em;"></span>
                </div>
            </div>

            <div class="table-responsive" style="background: #fff; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); padding: 20px;">
                <table class="table table-bordered" id="openingStockTable" style="border-radius: 10px; overflow: hidden; border-collapse: separate; border-spacing: 0;">
                    <thead class="bg-gradient" style="background: linear-gradient(135deg, #1e3c72, #2a5298); color: #fff; text-transform: uppercase; letter-spacing: 1px;">
                        <tr>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">Item Name</th>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">Pc</th>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">Gr.Wt.</th>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">Less</th>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">Net.Wt.</th>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">Tunch (%)</th>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">Wstg (%)</th>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">TW (%)</th>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">Rate</th>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">Gold Fine</th>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">Total Amount</th>
                            <th style="padding: 15px; font-weight: 600; border: none; border-bottom: 2px solid #00d4ff;">Action</th>
                        </tr>
                    </thead>
                    <tbody style="background: #fff;">
                        @for (int i = 0; i < Model.Items.Count; i++)
                        {
                            <tr style="transition: all 0.3s ease; border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 10px;">
                                    <input asp-for="Items[i].Id" type="hidden" />
                                    <input asp-for="Items[i].UserId" type="hidden" />
                                    <select asp-for="Items[i].ItemId" class="form-control custom-select item-select" required style="border-radius: 10px; padding: 8px; border: 1px solid #ced4da; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); transition: all 0.3s ease;">
                                        <option value="">Select Item</option>
                                        @foreach (var item in ViewBag.ItemDropDown)
                                        {
                                            <option value="@item.Id" data-group="@item.GroupName" selected="@(Model.Items[i].ItemId == item.Id ? "selected" : null)">@item.ItemName</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Items[i].ItemId" class="text-danger" style="font-size: 0.9em;"></span>
                                </td>
                                <td style="padding: 10px;">
                                    <input asp-for="Items[i].Pc" type="number" class="form-control pc-input" min="0" step="1" value="@(Model.Items[i].Pc?.ToString() ?? "")" style="border-radius: 10px; padding: 8px; border: 1px solid #ced4da; transition: all 0.3s ease;" />
                                    <span asp-validation-for="Items[i].Pc" class="text-danger" style="font-size: 0.9em;"></span>
                                </td>
                                <td style="padding: 10px;">
                                    <input asp-for="Items[i].Weight" type="number" class="form-control weight-input" min="0" step="0.01" value="@(Model.Items[i].Weight?.ToString("F2") ?? "")" style="border-radius: 10px; padding: 8px; border: 1px solid #ced4da; transition: all 0.3s ease;" />
                                    <span asp-validation-for="Items[i].Weight" class="text-danger" style="font-size: 0.9em;"></span>
                                </td>
                                <td style="padding: 10px;">
                                    <input asp-for="Items[i].Less" type="number" class="form-control less-input" min="0" step="0.01" value="@(Model.Items[i].Less?.ToString("F2") ?? "")" style="border-radius: 10px; padding: 8px; border: 1px solid #ced4da; transition: all 0.3s ease;" />
                                    <span asp-validation-for="Items[i].Less" class="text-danger" style="font-size: 0.9em;"></span>
                                </td>
                                <td style="padding: 10px;">
                                    <input asp-for="Items[i].NetWt" type="number" class="form-control netwt-input" step="0.01" readonly value="@(Model.Items[i].NetWt?.ToString("F2") ?? "0.00")" style="border-radius: 10px; padding: 8px; background: #e9ecef; border: none;" />
                                    <span asp-validation-for="Items[i].NetWt" class="text-danger" style="font-size: 0.9em;"></span>
                                </td>
                                <td style="padding: 10px;">
                                    <input asp-for="Items[i].Tunch" type="number" class="form-control tunch-input" min="0" step="0.01" value="@(Model.Items[i].Tunch?.ToString("F2") ?? "")" style="border-radius: 10px; padding: 8px; border: 1px solid #ced4da; transition: all 0.3s ease;" />
                                    <span asp-validation-for="Items[i].Tunch" class="text-danger" style="font-size: 0.9em;"></span>
                                </td>
                                <td style="padding: 10px;">
                                    <input asp-for="Items[i].Wastage" type="number" class="form-control wastage-input" min="0" step="0.01" value="@(Model.Items[i].Wastage?.ToString("F2") ?? "")" style="border-radius: 10px; padding: 8px; border: 1px solid #ced4da; transition: all 0.3s ease;" />
                                    <span asp-validation-for="Items[i].Wastage" class="text-danger" style="font-size: 0.9em;"></span>
                                </td>
                                <td style="padding: 10px;">
                                    <input asp-for="Items[i].TW" type="number" class="form-control tw-input" step="0.01" readonly value="@(Model.Items[i].TW?.ToString("F2") ?? "0.00")" style="border-radius: 10px; padding: 8px; background: #e9ecef; border: none;" />
                                    <span asp-validation-for="Items[i].TW" class="text-danger" style="font-size: 0.9em;"></span>
                                </td>
                                <td style="padding: 10px;">
                                    <input asp-for="Items[i].Rate" type="number" class="form-control rate-input" min="0" step="0.01" value="@(Model.Items[i].Rate?.ToString("F2") ?? "")" style="border-radius: 10px; padding: 8px; border: 1px solid #ced4da; transition: all 0.3s ease;" />
                                    <span asp-validation-for="Items[i].Rate" class="text-danger" style="font-size: 0.9em;"></span>
                                </td>
                                <td style="padding: 10px;">
                                    <input asp-for="Items[i].Fine" type="number" class="form-control fine-input" step="0.01" readonly value="@(Model.Items[i].Fine?.ToString("F2") ?? "0.00")" style="border-radius: 10px; padding: 8px; background: #e9ecef; border: none;" />
                                    <span asp-validation-for="Items[i].Fine" class="text-danger" style="font-size: 0.9em;"></span>
                                </td>
                                <td style="padding: 10px;">
                                    <input type="number" class="form-control amount-input" step="0.01" readonly value="@(Model.Items[i].Amount?.ToString("F2") ?? "0.00")" style="border-radius: 10px; padding: 8px; background: #e9ecef; border: none;" />
                                    <input type="hidden" asp-for="Items[i].Amount" class="hidden-amount-input" value="@(Model.Items[i].Amount?.ToString("F2") ?? "0.00")" />
                                    <span asp-validation-for="Items[i].Amount" class="text-danger" style="font-size: 0.9em;"></span>
                                </td>
                                <td style="padding: 10px;">
                                    @if (i > 0)
                                    {
                                        <button type="button" class="btn btn-danger btn-sm remove-row-btn" style="border-radius: 50%; padding: 8px 12px; background: linear-gradient(to right, #dc3545, #ff6b6b); border: none; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);"><i class="bi bi-trash"></i></button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr class="bg-gradient text-white" style="background: linear-gradient(135deg, #6c757d, #adb5bd);">
                            <td colspan="2" class="text-right" style="font-weight: 600; padding: 15px; border: none;"><strong>Total:</strong></td>
                            <td style="padding: 10px;"><input type="number" step="0.01" id="totalGrWt" class="form-control" readonly value="0.00" style="border-radius: 10px; padding: 8px; background: #e9ecef; border: none;" /></td>
                            <td style="padding: 10px;"><input type="number" step="0.01" id="totalLess" class="form-control" readonly value="0.00" style="border-radius: 10px; padding: 8px; background: #e9ecef; border: none;" /></td>
                            <td style="padding: 10px;"><input type="number" step="0.01" id="totalNetWt" class="form-control" readonly value="0.00" style="border-radius: 10px; padding: 8px; background: #e9ecef; border: none;" /></td>
                            <td colspan="4" style="border: none;"></td>
                            <td style="padding: 10px;"><input type="number" step="0.01" id="totalFine" class="form-control" readonly value="0.00" style="border-radius: 10px; padding: 8px; background: #e9ecef; border: none;" /></td>
                            <td style="padding: 10px;"><input type="number" step="0.01" id="totalAmount" class="form-control" readonly value="0.00" style="border-radius: 10px; padding: 8px; background: #e9ecef; border: none;" /></td>
                            <td style="border: none;"></td>
                        </tr>
                    </tfoot>
                </table>
                <button type="button" class="btn btn-primary mb-3 add-row-btn" style="border-radius: 25px; padding: 10px 25px; background: linear-gradient(to right, #007bff, #00d4ff); border: none; transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">Add New Row</button>
            </div>

            <div class="row mt-4">
                <div class="col-md-12 text-center">
                    <button type="submit" class="btn btn-success" style="border-radius: 25px; padding: 12px 30px; background: linear-gradient(to right, #28a745, #67b26f); border: none; transition: all 0.3s ease; margin: 0 5px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">Save</button>
                    <a href="@Url.Action("ViewStock", "OpeningStock")" class="btn btn-danger" style="border-radius: 25px; padding: 12px 30px; background: linear-gradient(to right, #dc3545, #ff6b6b); border: none; transition: all 0.3s ease; margin: 0 5px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">Cancel</a>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
<script src="~/js/openingStock.js"></script>

<script>
    const addOpeningStockUrl = '@Url.Action("AddOpeningStock", "OpeningStock")';
    setupFormSubmission(addOpeningStockUrl); // No need for viewStockUrl here
    setupEventListeners();
</script>